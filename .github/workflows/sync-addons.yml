name: Sync Add-on Configs

on:
  schedule:
    - cron: "0 */6 * * *"  # Every 6 hours (fallback)
  workflow_dispatch:  # Manual trigger
  repository_dispatch:  # Triggered by source repo webhooks
    types: [sync-request]
  push:
    paths:
      - ".addons.yml"

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Sync add-on configs
        run: |
          set -e

          # Read each addon from .addons.yml
          for addon in $(yq e '.addons | keys | .[]' .addons.yml); do
            echo "Processing addon: $addon"

            repo=$(yq e ".addons.${addon}.repository" .addons.yml)
            branch=$(yq e ".addons.${addon}.branch // \"main\"" .addons.yml)
            source_path=$(yq e ".addons.${addon}.source_path // \"\"" .addons.yml)
            target=$(yq e ".addons.${addon}.target" .addons.yml)
            image=$(yq e ".addons.${addon}.image" .addons.yml)

            echo "  Repository: $repo"
            echo "  Branch: $branch"
            echo "  Source path: $source_path"
            echo "  Target: $target"
            echo "  Image: $image"

            # Create target directory if it doesn't exist
            mkdir -p "$target"

            # Build base URL with optional source path
            if [ -n "$source_path" ]; then
              base_url="https://raw.githubusercontent.com/${repo}/${branch}/${source_path}"
            else
              base_url="https://raw.githubusercontent.com/${repo}/${branch}"
            fi

            # Try to fetch config.yaml, fall back to config.json
            config_url="${base_url}/config.yaml"
            config_file="config.yaml"

            if ! curl -sfL "$config_url" -o "${target}/${config_file}" 2>/dev/null; then
              # Try config.json
              config_url="${base_url}/config.json"
              config_file="config.json"

              if ! curl -sfL "$config_url" -o "${target}/${config_file}" 2>/dev/null; then
                echo "  Warning: No config.yaml or config.json found in $repo"
                continue
              fi
            fi

            echo "  Downloaded: $config_file"

            # Override image in config if specified in .addons.yml
            if [ "$image" != "null" ]; then
              if [ "$config_file" = "config.yaml" ]; then
                yq e -i ".image = \"${image}\"" "${target}/${config_file}"
              else
                # For JSON, use jq if available, otherwise leave as-is
                if command -v jq &> /dev/null; then
                  tmp=$(mktemp)
                  jq --arg img "$image" '.image = $img' "${target}/${config_file}" > "$tmp"
                  mv "$tmp" "${target}/${config_file}"
                fi
              fi
              echo "  Updated image to: $image"
            fi

            # Also sync optional files if they exist
            for file in README.md icon.png logo.png DOCS.md CHANGELOG.md Dockerfile build.yaml requirements.txt run.sh database_schema.sql; do
              file_url="${base_url}/${file}"
              if curl -sfL "$file_url" -o "${target}/${file}" 2>/dev/null; then
                echo "  Downloaded: $file"
                # Make shell scripts executable
                if [[ "$file" == *.sh ]]; then
                  chmod +x "${target}/${file}"
                fi
              else
                rm -f "${target}/${file}" 2>/dev/null || true
              fi
            done

            # Sync source directories if they exist (for local builds)
            for dir in src frontend migrations; do
              dir_check_url="${base_url}/${dir}/"
              if curl -sfL --head "${base_url}/${dir}" 2>/dev/null | grep -q "200\|301\|302"; then
                echo "  Syncing directory: $dir"
                rm -rf "${target}/${dir}"
                mkdir -p "${target}/${dir}"
                # Use git sparse checkout for directory sync
                temp_dir=$(mktemp -d)
                git clone --depth 1 --filter=blob:none --sparse "https://github.com/${repo}" "$temp_dir" 2>/dev/null || true
                if [ -d "$temp_dir" ]; then
                  cd "$temp_dir"
                  git sparse-checkout set "${source_path}/${dir}" 2>/dev/null || true
                  git checkout "$branch" 2>/dev/null || true
                  if [ -d "${source_path}/${dir}" ]; then
                    cp -r "${source_path}/${dir}"/* "${GITHUB_WORKSPACE}/${target}/${dir}/" 2>/dev/null || true
                  fi
                  cd "$GITHUB_WORKSPACE"
                  rm -rf "$temp_dir"
                  echo "    Done syncing $dir"
                fi
              fi
            done

            echo "  Done!"
          done

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add -A

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Sync add-on configs from source repositories"
            git push
          fi
